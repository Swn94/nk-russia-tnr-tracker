name: Event-Triggered PR Creation

on:
  repository_dispatch:
    types:
      - new_case
      - new_evidence
      - sanctions_update
      - urgent_alert

jobs:
  process-event:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Process Event Data
        id: process
        run: |
          echo "Event type: ${{ github.event.action }}"
          echo "Payload: ${{ toJson(github.event.client_payload) }}"

          # Extract event data
          EVENT_TYPE="${{ github.event.action }}"
          CASE_ID="${{ github.event.client_payload.case_id }}"
          ACTOR_ID="${{ github.event.client_payload.actor_id }}"
          SEVERITY="${{ github.event.client_payload.severity }}"
          TITLE="${{ github.event.client_payload.title }}"

          # Set outputs
          echo "event_type=${EVENT_TYPE}" >> $GITHUB_OUTPUT
          echo "case_id=${CASE_ID}" >> $GITHUB_OUTPUT
          echo "severity=${SEVERITY}" >> $GITHUB_OUTPUT
          echo "title=${TITLE}" >> $GITHUB_OUTPUT

          # Determine branch name
          BRANCH_NAME="event/${EVENT_TYPE}-$(date +%Y%m%d-%H%M%S)"
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT

      - name: Create Event Branch
        run: |
          git config user.name "TNR Tracker Bot"
          git config user.email "bot@tnr-tracker.local"

          git checkout -b ${{ steps.process.outputs.branch_name }}

      - name: Generate Event Report
        run: |
          mkdir -p data/events

          cat > data/events/${{ steps.process.outputs.event_type }}-$(date +%Y%m%d%H%M%S).json << 'EOF'
          {
            "event_type": "${{ steps.process.outputs.event_type }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "payload": ${{ toJson(github.event.client_payload) }},
            "workflow_run_id": "${{ github.run_id }}"
          }
          EOF

      - name: Commit Changes
        run: |
          git add data/events/
          git commit -m "Add event: ${{ steps.process.outputs.event_type }} - ${{ steps.process.outputs.title }}"
          git push origin ${{ steps.process.outputs.branch_name }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.process.outputs.branch_name }}
          base: main
          title: "[${{ steps.process.outputs.event_type }}] ${{ steps.process.outputs.title }}"
          body: |
            ## Event Details

            **Type:** ${{ steps.process.outputs.event_type }}
            **Severity:** ${{ steps.process.outputs.severity || 'N/A' }}
            **Case ID:** ${{ steps.process.outputs.case_id || 'N/A' }}

            ### Payload
            ```json
            ${{ toJson(github.event.client_payload) }}
            ```

            ### Required Actions
            - [ ] Review event data
            - [ ] Verify information accuracy
            - [ ] Update database if needed
            - [ ] Notify relevant stakeholders

            ---
            *This PR was automatically created by the TNR Tracker event system.*
          labels: |
            event
            ${{ steps.process.outputs.event_type }}
            automated
          reviewers: |
            maintainers
          draft: false

  urgent-notification:
    runs-on: ubuntu-latest
    if: github.event.action == 'urgent_alert'

    steps:
      - name: Send Urgent Notification
        uses: actions/github-script@v7
        with:
          script: |
            const payload = context.payload.client_payload;

            // Create urgent issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ URGENT: ${payload.title}`,
              body: `## Urgent Alert

            **Severity:** ${payload.severity}
            **Source:** ${payload.source || 'Unknown'}

            ### Details
            ${payload.description || 'No additional details provided.'}

            ### Immediate Actions Required
            - Review this alert immediately
            - Coordinate with relevant teams
            - Document response actions

            ---
            *Timestamp: ${new Date().toISOString()}*`,
              labels: ['urgent', 'alert', 'priority-1']
            });

            console.log('Urgent issue created successfully');
